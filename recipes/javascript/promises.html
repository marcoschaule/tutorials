<!DOCTYPE html><html><head><meta charset="utf8"><title>Promises</title><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css"><link rel="stylesheet" type="text/css" href="/tutorials/css/styles.css"><base href="/tutorials/"></head><body><div class="container" id="container"><header id="header"><div id="title"><a href="/tutorials/">Tutorials</a></div><div id="subtitle">Learning by Recipes.</div></header><nav id="navigation"><a href="/tutorials/">Home</a><a class="active" href="/tutorials/blog.html">Blog</a><a href="/tutorials/about.html">About</a><a href="/tutorials/contact.html">Contact</a></nav><main id="content"><div class="page-Promises"><h1>Promises</h1><p><h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>If a function cannot return a value or throw an exception
without blocking, it can return a promise instead.
A promise is an object that represents the return
value or the thrown exception that the function
may eventually provide.
A promise can also be used as a proxy for a remote
object to overcome latency.</p>
<p>There are multiple promise frameworks (including a native
ECMAScript 6 Promise library). The most important ones are:</p>
<ul>
<li><a href="https://github.com/kriskowal/q" target="_blank" rel="external">Q</a> (also used in AngularJS 1.x as <code>$q</code>)</li>
<li><a href="https://github.com/cujojs/when" target="_blank" rel="external">When</a></li>
<li><a href="http://bluebirdjs.com/docs/getting-started.html" target="_blank" rel="external">Bluebird</a></li>
</ul>
<p>To stick with the AngularJS 1.x idea, we continue with using the Q framework.</p>
<h2 id="Why-to-use-promises"><a href="#Why-to-use-promises" class="headerlink" title="Why to use promises"></a>Why to use promises</h2><p>To avoid the
<a href="recipes/javascript/callbacks.html#Callback-Hell-or-Pyramid-of-Doom">Callback Hells</a>
you can use promises to flatten the code structure.</p>
<p>Instead of writing:
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">step1(<span class="function"><span class="keyword">function</span> (<span class="params">value1</span>) </span>&#123;</div><div class="line">    <span class="comment">// Do something with value1</span></div><div class="line">    step2(value1, <span class="function"><span class="keyword">function</span>(<span class="params">value2</span>) </span>&#123;</div><div class="line">      <span class="comment">// Do something with value2</span></div><div class="line">        step3(value2, <span class="function"><span class="keyword">function</span>(<span class="params">value3</span>) </span>&#123;</div><div class="line">            <span class="comment">// Do something with value3</span></div><div class="line">            step4(value3, <span class="function"><span class="keyword">function</span>(<span class="params">value4</span>) </span>&#123;</div><div class="line">                <span class="comment">// Do something with value4</span></div><div class="line">            &#125;);</div><div class="line">        &#125;);</div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>You could write:
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Q.fcall(promisedStep1)</div><div class="line">    .then(promisedStep2)</div><div class="line">    .then(promisedStep3)</div><div class="line">    .then(promisedStep4)</div><div class="line">    <span class="comment">// error function to be called in case of any error beforehand</span></div><div class="line">    .fail(<span class="function"><span class="keyword">function</span>(<span class="params">objErr</span>) </span>&#123;</div><div class="line">      <span class="comment">// Handle any error from all above steps</span></div><div class="line">    &#125;)</div><div class="line">    <span class="comment">// final function to be called in case the promises ended (successfully or not)</span></div><div class="line">    .fin(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="comment">// Handle any postfix operations</span></div><div class="line">    &#125;)</div><div class="line">    .done();</div></pre></td></tr></table></figure></p>
<h2 id="Handling-promises"><a href="#Handling-promises" class="headerlink" title="Handling promises"></a>Handling promises</h2><p>When receiving a promise, you can call the <code>then</code> method
to handle the resolved or rejected (or progressed) value:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">somePromise.then(</div><div class="line">    </div><div class="line">    <span class="comment">// success handler</span></div><div class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">anySuccess</span>) </span>&#123; <span class="comment">/* handle success */</span> &#125;,</div><div class="line">    </div><div class="line">    <span class="comment">// error handler</span></div><div class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">anyErr</span>) </span>&#123; <span class="comment">/* handle error */</span> &#125;,</div><div class="line">    </div><div class="line">    <span class="comment">// progress handler</span></div><div class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">anyProgress</span>) </span>&#123; <span class="comment">/* handle progress */</span> &#125;</div><div class="line">);</div></pre></td></tr></table></figure>
<ul>
<li>The success handler is executed, if the promise <code>somePromise</code>
has been resolved successfully.</li>
<li>The error handler is executed, if the promise <code>somePromise</code>
has been rejected with an error or if an error was thrown
in any success handler beforehand.</li>
<li>The progress handler is executed every time, a progress notification
is fired from the promise <code>somePromise</code>.</li>
</ul>
<p>Alternatively to the three handlers given to <code>then</code> method,
Q offers methods for each case individually:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">somePromise</div><div class="line">  .then(<span class="function"><span class="keyword">function</span> <span class="title">someSuccessHandler</span>(<span class="params"></span>)</span>&#123; <span class="comment">/* handle success */</span> &#125;)</div><div class="line">  .fail(<span class="function"><span class="keyword">function</span> <span class="title">someErrorHandler</span>(<span class="params"></span>)</span>&#123; <span class="comment">/* handle error */</span> &#125;)</div><div class="line">  .progress(<span class="function"><span class="keyword">function</span> <span class="title">someProgressHandler</span>(<span class="params"></span>)</span>&#123; <span class="comment">/* handle progress */</span> &#125;)</div><div class="line">  ;</div></pre></td></tr></table></figure>
<ul>
<li>The <code>fail</code> method is shorthand for <code>then(null, someErrorHandler)</code>.
On newer clients or in Node.js you could use <code>catch</code> instead of <code>fail</code>.</li>
<li>The <code>progress</code> method is shorthand for <code>then(null, null, someProgressHandler)</code>.
Anyway, this method is deprecated on version 2 and will be replaced by
the <code>promise.observeEstimate</code> method.</li>
</ul>
<p>Additionally to the <code>then</code>, the <code>fail</code> and the <code>progress</code> methods, there are
the following methods available:</p>
<ul>
<li><code>fin</code> to end a promise and to assure that unhandled exceptions 
get rethrown and reported. This handler is called without any argument.
On newer clients or in Node.js you could use <code>finally</code> instead of <code>fin</code>.</li>
<li><code>delay</code> to delay a chain for several milliseconds.</li>
<li>and others …</li>
</ul>
<p>For example:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">somePromise</div><div class="line">  .then(<span class="function"><span class="keyword">function</span> <span class="title">someSuccessHandler1</span>(<span class="params"></span>)</span>&#123; <span class="comment">/* handle success */</span> &#125;)</div><div class="line">  .then(<span class="function"><span class="keyword">function</span> <span class="title">someSuccessHandler2</span>(<span class="params"></span>)</span>&#123; <span class="comment">/* handle success */</span> &#125;)</div><div class="line">  .delay(<span class="number">50000</span>) <span class="comment">// delay processing for 5 seconds</span></div><div class="line">  .then(<span class="function"><span class="keyword">function</span> <span class="title">someSuccessHandler3</span>(<span class="params"></span>)</span>&#123; <span class="comment">/* handle success */</span> &#125;)</div><div class="line">  .fail(<span class="function"><span class="keyword">function</span> <span class="title">someErrorHandler</span>(<span class="params"></span>)</span>&#123; <span class="comment">/* handle error */</span> &#125;)</div><div class="line">  .progress(<span class="function"><span class="keyword">function</span> <span class="title">someProgressHandler</span>(<span class="params"></span>)</span>&#123; <span class="comment">/* handle progress */</span> &#125;)</div><div class="line">  .fin(<span class="function"><span class="keyword">function</span> <span class="title">someFinalHandler</span>(<span class="params"></span>) </span>&#123; <span class="comment">/* handle final steps */</span> &#125;)</div><div class="line">  ;</div></pre></td></tr></table></figure>
<ul>
<li>The <code>then</code> functions are called in order or definition, whereas the third
<code>then</code> call is delayed for 5 seconds.</li>
<li>If any <code>then</code> throws an error, the fail is immediately called, without waiting
for the next <code>then</code> to finish.</li>
<li>If any <code>then</code> or the promise <code>somePromise</code> is rejected, the fail is immediately
called, without waiting for the next <code>then</code> to finish.</li>
<li>The <code>fin</code> method is called at the end, after each <code>then</code> has been resolved
of the <code>fail</code> has been fired because of an error.</li>
</ul>
<h2 id="Creating-a-Promise"><a href="#Creating-a-Promise" class="headerlink" title="Creating a Promise"></a>Creating a Promise</h2><p>To create a promise, you can use multiple methods:</p>
<h3 id="Using-Deferreds"><a href="#Using-Deferreds" class="headerlink" title="Using Deferreds:"></a>Using Deferreds:</h3><p>You can use a deferred object to create a promise on demand.
This deferred object can be returned and is either
fulfilled or rejected (at least one tick) later.</p>
<p>Using Node’s file libary to load a file with promises
would look like the following:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">readFilePromise</span>(<span class="params">strFilePathAndName</span>)</span>&#123;</div><div class="line">  <span class="keyword">var</span> deferred = Q.defer();</div><div class="line"></div><div class="line">  fs.readFile(strFilePathAndName, <span class="string">'utf-8'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">objErr, strContent</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (objErr) &#123;</div><div class="line">      deferred.reject(<span class="keyword">new</span> <span class="built_in">Error</span>(objErr));</div><div class="line">    &#125;</div><div class="line">    deferred.resolve(strContent);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="keyword">return</span> deferred.promise;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Now this function can be called as a promise:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">readFilePromise</div><div class="line"> .then(<span class="function"><span class="keyword">function</span>(<span class="params">strContent</span>) </span>&#123;</div><div class="line">   <span class="comment">// handle content</span></div><div class="line"> &#125;);</div></pre></td></tr></table></figure>
<h3 id="Using-Q-fcall-and-Q-fapply"><a href="#Using-Q-fcall-and-Q-fapply" class="headerlink" title="Using Q.fcall and Q.fapply:"></a>Using <code>Q.fcall</code> and <code>Q.fapply</code>:</h3><p>You can use the function <code>fcall</code> (<em>function call</em>) to - as the
name suggests - call a function or <code>fapply</code> respectively.
This method calls a given function, and retuns a promise, which is</p>
<ul>
<li>resolved, if the function returns a value, or</li>
<li>rejected, if the function throws an error.</li>
</ul>
<p>Success case:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// create the promise by wrapping a function: </span></div><div class="line"><span class="keyword">var</span> somePromise = Q.fcall(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">'someString'</span>;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// then handle it like a promise:</span></div><div class="line">somePromise</div><div class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params">str</span>) </span>&#123;</div><div class="line">    <span class="comment">// str === 'someString'</span></div><div class="line">    <span class="comment">// handle success</span></div><div class="line">  &#125;)</div><div class="line">  <span class="comment">//...</span></div><div class="line">  ;</div></pre></td></tr></table></figure>
<p>Error case:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// create the promise by wrapping a function: </span></div><div class="line"><span class="keyword">var</span> somePromise = Q.fcall(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Some error happened!'</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// then handle it like a promise:</span></div><div class="line">somePromise</div><div class="line">  .then() <span class="comment">// is ignored</span></div><div class="line">  .fail(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="comment">//handle error */</span></div><div class="line">  &#125;)</div><div class="line">  <span class="comment">//...</span></div></pre></td></tr></table></figure>
<p>Alternatives to <code>fcall</code> and  <code>fapply</code> are <code>nfcall</code> and <code>nfapply</code> respectively.
They are used to wrap <em>node function calls</em> which use node-default callback
signatures like <code>function callback(objErr, objResult){}</code>.</p>
<h3 id="Promise-combinations"><a href="#Promise-combinations" class="headerlink" title="Promise combinations"></a>Promise combinations</h3><p>If you have an array of promises, you can call <code>Q.all()</code> to wait for all
of them to be resolved:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> arrPromises = [somePromise1, somePromise2, somePromise3];</div><div class="line"></div><div class="line">Q.all(arrPromises)</div><div class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params">arrResults</span>) </span>&#123;</div><div class="line">    <span class="comment">// handle results</span></div><div class="line">    <span class="comment">// arrResults[0] is the resolved result if somePromise1</span></div><div class="line">    <span class="comment">// arrResults[1] is the resolved result if somePromise2</span></div><div class="line">    <span class="comment">// arrResults[2] is the resolved result if somePromise3</span></div><div class="line">  &#125;)</div><div class="line">  .fail(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="comment">/* handle any error */</span> &#125;)</div><div class="line">  ;</div></pre></td></tr></table></figure>
<p>If any of the promises is rejected, though,
the <code>then</code> is ignored and the <code>fail</code> is called immediately.
The exact same method works for objects, too:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> arrPromises = &#123;<span class="attr">a</span>: somePromise1, <span class="attr">b</span>: somePromise2, <span class="attr">c</span>: somePromise3&#125;;</div><div class="line"></div><div class="line">Q.all(arrPromises)</div><div class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params">objResults</span>) </span>&#123;</div><div class="line">    <span class="comment">// handle results</span></div><div class="line">    <span class="comment">// objResults.a is the resolved result if somePromise1</span></div><div class="line">    <span class="comment">// objResults.b is the resolved result if somePromise2</span></div><div class="line">    <span class="comment">// objResults.c is the resolved result if somePromise3</span></div><div class="line">  &#125;)</div><div class="line">  .fail(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="comment">/* handle any error */</span> &#125;)</div><div class="line">  ;</div></pre></td></tr></table></figure>
<p>If you want to wait for all promises to have either been resolved or
rejected, you can use the <code>Q.allSettled()</code> method:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> arrPromises = &#123;<span class="attr">a</span>: somePromise1, <span class="attr">b</span>: somePromise2, <span class="attr">c</span>: somePromise3&#125;;</div><div class="line"></div><div class="line">Q.allSettled(arrPromises)</div><div class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params">objResults</span>) </span>&#123;</div><div class="line">    <span class="comment">// handle results</span></div><div class="line">    <span class="comment">// objResults.a is the resolved result if somePromise1</span></div><div class="line">    <span class="comment">// objResults.b is the resolved result if somePromise2</span></div><div class="line">    <span class="comment">// objResults.c is the resolved result if somePromise3</span></div><div class="line">  &#125;)</div><div class="line">  .fail(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="comment">/* handly any error */</span> &#125;)</div><div class="line">  ;</div></pre></td></tr></table></figure>
<p>In contrast, if you want to finish the promise if at least one has
been fulfilled, you can use the <code>Q.any()</code> method:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> arrPromises = &#123;<span class="attr">a</span>: somePromise1, <span class="attr">b</span>: somePromise2, <span class="attr">c</span>: somePromise3&#125;;</div><div class="line"></div><div class="line">Q.allSettled(arrPromises)</div><div class="line">  .any(<span class="function"><span class="keyword">function</span>(<span class="params">anyFirst</span>) </span>&#123; <span class="comment">/* handles the first result results */</span> &#125;)</div><div class="line">  .fail(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="comment">/* handle errors if all are rejected */</span> &#125;)</div><div class="line">  ;</div></pre></td></tr></table></figure>
<p>To be continued…</p>
</p></div></main><footer id="footer"><hr>&copy; by Marco Schaule
&nbsp;&nbsp;/&nbsp;&nbsp;&nbsp;<a href="/tutorials/imprint.html" title="Imprint">Imprint</a></footer></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script><script src="/tutorials/scripts/scripts.js"></script></body></html>